<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    
    <style>
      body {
        background-color: #f4f6f9;
        color: #333;
        font-family: "Helvetica Neue", Arial, sans-serif;
        padding: 20px;
      }

      /* タイムライン */
      .timeline {
        position: relative;
        padding: 20px 0;
        max-width: 900px; /* 少し広げる */
        margin: 0 auto;
      }
      .timeline::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 20px;
        width: 3px;
        background: #dee2e6;
      }
      
      .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-left: 50px;
      }
      
      .timeline-dot {
        position: absolute;
        left: 11px;
        top: 24px; /* カードの上端に合わせる */
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #0d6efd;
        border: 4px solid #fff;
        box-shadow: 0 0 0 1px #dee2e6;
        z-index: 1;
      }

      /* ▼▼▼ カードデザイン変更 (横並びフレックス) ▼▼▼ */
      .event-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        cursor: pointer;
        display: flex; /* フレックスボックス化 */
        flex-direction: row; /* 横並び */
        min-height: 180px; /* 最低限の高さを確保 */
      }
      .event-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }

      /* ▼▼▼ 左側の画像エリア (正方形の枠) ▼▼▼ */
      .card-img-left-wrapper {
        width: 180px;  /* 固定幅 */
        height: 240px; /* 固定高さ (正方形) */
        flex-shrink: 0; /* 縮小させない */
        background-color: #f8f9fa; /* 画像がない部分の背景色 */
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        border-right: 1px solid #eee;
        cursor: pointer; /* クリック可能を示す */
      }
      .card-img-left-wrapper img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain !important; /* ▼重要: 全体が表示されるように収める */
        display: block;
      }
      .card-img-left-wrapper:hover {
        background-color: #e9ecef;
      }

      /* 右側の本文エリア */
      .event-card .card-body {
        flex: 1; /* 残りの幅を埋める */
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center; /* 上下中央寄せ */
      }

      /* 編集アイコン（ホバー時） */
      .edit-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255,255,255,0.9);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 2;
      }
      .event-card:hover .edit-overlay {
        opacity: 1;
      }

      .no-image {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #ccc;
        flex-direction: column;
      }
      .no-image i { font-size: 2.5rem; }
      .no-image span { font-size: 0.7rem; margin-top: 5px;}

      /* 日付バッジ */
      .date-badge {
        display: inline-block;
        background: #e9ecef;
        color: #495057;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .date-badge i { color: #0d6efd; margin-right: 5px; }

      /* メンバータグ */
      .member-tag {
        font-size: 0.75rem;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        color: #6c757d;
        padding: 2px 8px;
        border-radius: 4px;
        margin-right: 4px;
        margin-bottom: 4px;
        display: inline-block;
      }

      /* FAB */
      .fab-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        font-size: 24px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        flex-direction: column;
        color: #6c757d;
      }

      /* フォトビューアーモーダル */
      .photo-viewer-modal .modal-dialog {
        max-width: 90vw;
        max-height: 90vh;
        margin: 1.75rem auto;
      }
      .photo-viewer-modal .modal-content {
        background-color: #000;
        border: none;
        height: 90vh;
      }
      .photo-viewer-modal .modal-header {
        background-color: rgba(0,0,0,0.9);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        color: white;
      }
      .photo-viewer-modal .modal-body {
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #000;
        position: relative;
        overflow: hidden;
        min-height: 60vh;
      }
      .photo-viewer-modal .modal-body img {
        max-width: 90%;
        max-height: 70vh;
        width: auto !important;
        height: auto !important;
        object-fit: contain !important;
        object-position: center !important;
        display: block;
        margin: auto;
      }
      .photo-nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        font-size: 2rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 10;
      }
      .photo-nav-btn:hover {
        background: rgba(255,255,255,0.4);
      }
      .photo-nav-btn.prev {
        left: 20px;
      }
      .photo-nav-btn.next {
        right: 20px;
      }
      .photo-counter {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
      }
      .photo-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
      }
    </style>
  </head>
  <body>

    <h2 class="text-center fw-bold mb-5">
      <i class="bi bi-clock-history text-primary"></i> イベント履歴
      <div class="fs-6 text-muted fw-normal mt-1">会社イベントとカルチャーの軌跡</div>
    </h2>

    <div class="timeline" id="timelineContainer">
      <div class="loading-container">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <span>読み込み中...</span>
      </div>
    </div>

    <button class="btn btn-primary fab-btn" onclick="openRegisterModal()">
      <i class="bi bi-plus-lg"></i>
    </button>

    <!-- フォトビューアーモーダル -->
    <div class="modal fade photo-viewer-modal" id="photoViewerModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="photoViewerTitle">フォトアルバム</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="photo-loading" id="photoLoading">
              <div class="spinner-border text-light" role="status"></div>
            </div>
            <img id="photoViewerImage" src="" alt="Photo" style="display: none;">
            <button class="photo-nav-btn prev" id="prevPhotoBtn" onclick="navigatePhoto(-1)" style="display: none;">
              <i class="bi bi-chevron-left"></i>
            </button>
            <button class="photo-nav-btn next" id="nextPhotoBtn" onclick="navigatePhoto(1)" style="display: none;">
              <i class="bi bi-chevron-right"></i>
            </button>
            <div class="photo-counter" id="photoCounter" style="display: none;">1 / 1</div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="dataModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold" id="modalTitle">イベント登録</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="form">
              <input type="hidden" id="rowNumber">
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold small text-muted">開催日</label>
                  <input type="date" class="form-control" id="date" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold small text-muted">イベント名</label>
                  <input type="text" class="form-control" id="name" required>
                </div>
              </div>

              <div class="row">
                 <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold small text-muted">場所</label>
                  <input type="text" class="form-control" id="location">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold small text-muted">参加人数</label>
                  <input type="number" class="form-control" id="count">
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold small text-muted">アルバムURL</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="albumUrl" placeholder="https://photos.app.goo.gl/...">
                    <button class="btn btn-outline-secondary" type="button" onclick="openLink('albumUrl')">開く</button>
                  </div>
                  <div class="form-text small">※保存時に自動的に最初の画像を表紙に設定します</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold small text-muted">関連資料URL</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="docUrl" placeholder="https://notion.so/...">
                    <button class="btn btn-outline-secondary" type="button" onclick="openLink('docUrl')">開く</button>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-bold small text-muted">参加メンバー</label>
                <textarea class="form-control" id="members" rows="2" placeholder="カンマ区切りで入力"></textarea>
              </div>

            </form>
          </div>
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-outline-danger me-auto" id="deleteBtn" style="display:none;" onclick="deleteCurrentData()">削除</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            <button type="button" class="btn btn-primary px-4" id="saveBtn" onclick="saveData()">保存</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // SPA対応：既に存在する場合は再利用
      if (typeof currentDataList === 'undefined') var currentDataList = [];
      if (typeof currentPhotos === 'undefined') var currentPhotos = [];
      if (typeof currentPhotoIndex === 'undefined') var currentPhotoIndex = 0;

      // ★SPA対応: 初期化関数をグローバルスコープに公開
      function initEventsPage() {
        loadData();
      }

      window.onload = function() { 
        if (typeof initEventsPage === 'function') {
          initEventsPage();
        }
      };

      function loadData() { 
        const container = document.getElementById('timelineContainer');
        // 常にローディング表示を挿入（再読み込み対応）
        container.innerHTML = `
          <div class="loading-container">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
            <span>読み込み中...</span>
          </div>`;
        google.script.run.withSuccessHandler(render).getEventData(); 
      }
     
      function render(data) {
        currentDataList = data;
        const container = document.getElementById('timelineContainer');
        container.innerHTML = "";
        
        if(!data || data.length === 0) { 
          container.innerHTML = "<div class='text-center py-5 text-muted'>履歴なし</div>"; 
          return; 
        }
       
        data.sort((a, b) => new Date(b.data[0]) - new Date(a.data[0]));

        data.forEach(item => {
          const d = item.data;
          // d: [0:date, 1:name, 2:loc, 3:count, 4:albumUrl, 5:thumbUrl, 6:docUrl, 7:members] ※画像位置は削除

          let thumbUrl = d[5];
          
          let imgHtml = `<div class="no-image"><i class="bi bi-image"></i><span>No Image</span></div>`;
          
          if (thumbUrl && thumbUrl.startsWith('http')) {
            if (thumbUrl.includes('drive.google.com/file/d/')) {
               const idMatch = thumbUrl.match(/\/d\/(.+?)\//);
               if(idMatch) thumbUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w800`;
            }
            // エラー時は"No Image"プレースホルダーを表示
            imgHtml = `<img src="${thumbUrl}" alt="${d[1]}" onerror="this.onerror=null; this.style.display='none'; this.parentNode.querySelector('.no-image').style.display='flex';">
                       <div class="no-image" style="display:none;"><i class="bi bi-image"></i><span>No Image</span></div>`;
          }

          let membersHtml = '';
          if (d[7]) {
            d[7].toString().split(/[、,]/).forEach(m => {
              if(m.trim()) membersHtml += `<span class="member-tag"><i class="bi bi-person-fill"></i>${m.trim()}</span>`;
            });
          }

          let buttonsHtml = '';
          if (d[4]) {
            buttonsHtml += `<a href="${d[4]}" target="_blank" class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="event.stopPropagation()"><i class="bi bi-images"></i> フォトアルバム</a>`;
          }
          if (d[6]) {
            buttonsHtml += `<a href="${d[6]}" target="_blank" class="btn btn-sm btn-outline-dark me-2 mb-2" onclick="event.stopPropagation()"><i class="bi bi-file-earmark-text"></i> 資料/議事録</a>`;
          }

          // ▼ HTML構造を左右分割に変更
          const albumUrl = d[4] || ''; // アルバムURL
          const hasAlbum = albumUrl && albumUrl.startsWith('http');
          const eventName = (d[1] || '').replace(/'/g, '&apos;'); // シングルクォートをエスケープ
          
          // 画像エリアにクリックイベントを追加（アルバムがある場合）
          // data属性を使ってURLを安全に渡す
          const imgClickEvent = hasAlbum 
            ? `onclick="event.stopPropagation(); openPhotoViewerFromElement(this)" data-album-url="${albumUrl}" data-event-name="${eventName}"` 
            : '';
          
          const html = `
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="card event-card" onclick="openEditModal(${item.rowNumber})">
                
                <div class="card-img-left-wrapper" ${imgClickEvent} title="${hasAlbum ? 'クリックして写真を表示' : ''}">
                  ${imgHtml}
                  ${hasAlbum ? '<div class="position-absolute bottom-0 end-0 m-2"><span class="badge bg-dark bg-opacity-75"><i class="bi bi-images"></i></span></div>' : ''}
                  <div class="edit-overlay"><i class="bi bi-pencil-fill text-muted small"></i></div>
                </div>

                <div class="card-body">
                  <div><span class="date-badge"><i class="bi bi-calendar3"></i> ${d[0]}</span></div>
                  <h5 class="card-title fw-bold mb-2">${d[1]}</h5>
                  <div class="text-muted small mb-3">
                    <span class="me-3"><i class="bi bi-geo-alt"></i> ${d[2] || '-'}</span>
                    <span><i class="bi bi-people"></i> ${d[3] ? d[3]+'名' : '-'}</span>
                  </div>
                  <div class="mb-3">${membersHtml}</div>
                  <div class="d-flex flex-wrap">${buttonsHtml}</div>
                </div>
              </div>
            </div>
          `;
          container.insertAdjacentHTML('beforeend', html);
        });
      }

      function openLink(inputId) {
        const url = document.getElementById(inputId).value;
        if(url && url.startsWith('http')) {
          window.open(url, '_blank');
        } else {
          alert("有効なURLがありません");
        }
      }

      // 要素からアルバム情報を取得してフォトビューアーを開く
      function openPhotoViewerFromElement(element) {
        const albumUrl = element.getAttribute('data-album-url');
        const eventName = element.getAttribute('data-event-name');
        
        if (albumUrl) {
          openPhotoViewer(albumUrl, eventName);
        }
      }

      // フォトビューアーを開く
      function openPhotoViewer(albumUrl, eventName) {
        // 前回のデータをクリア
        currentPhotos = [];
        currentPhotoIndex = 0;
        
        console.log('=== フォトビューアー起動 ===');
        console.log('アルバムURL:', albumUrl);
        console.log('イベント名:', eventName);
        
        document.getElementById('photoViewerTitle').innerText = eventName + ' - フォトアルバム';
        document.getElementById('photoLoading').style.display = 'flex';
        document.getElementById('photoLoading').innerHTML = '<div class="spinner-border text-light" role="status"></div><div class="text-light mt-2">写真を読み込んでいます...</div>';
        document.getElementById('photoViewerImage').style.display = 'none';
        document.getElementById('prevPhotoBtn').style.display = 'none';
        document.getElementById('nextPhotoBtn').style.display = 'none';
        document.getElementById('photoCounter').style.display = 'none';
        
        const modal = new bootstrap.Modal(document.getElementById('photoViewerModal'));
        modal.show();
        
        // GASから写真リストを取得
        google.script.run
          .withSuccessHandler(function(photos) {
            console.log('=== GASからの写真取得成功 ===');
            console.log('取得枚数:', photos ? photos.length : 0);
            
            if (photos && photos.length > 0) {
              console.log('写真URLリスト:');
              photos.forEach((url, index) => {
                console.log((index + 1) + ':', url);
              });
              
              currentPhotos = photos;
              currentPhotoIndex = 0;
              showPhoto(0);
            } else {
              console.warn('写真が取得できませんでした（0件）');
              // エラーではなく、わかりやすいメッセージを表示
              document.getElementById('photoLoading').innerHTML = 
                '<div class="text-light text-center"><i class="bi bi-images fs-1 mb-3 d-block"></i><div class="mb-2">写真が見つかりませんでした</div><small class="text-muted">アルバムが空か、アクセスできない可能性があります</small></div>';
            }
          })
          .withFailureHandler(function(error) {
            console.error('=== GASからの写真取得失敗 ===');
            console.error('エラー:', error);
            document.getElementById('photoLoading').innerHTML = 
              '<div class="text-light text-center"><i class="bi bi-exclamation-triangle fs-1 mb-3 d-block"></i><div class="mb-2">読み込みエラー</div><small>' + (error.message || 'サーバーエラーが発生しました') + '</small></div>';
          })
          .getAllPhotosFromAlbum(albumUrl);
      }
      
      // 写真を表示
      function showPhoto(index) {
        if (!currentPhotos || currentPhotos.length === 0) {
          console.warn('showPhoto: 表示する写真がありません');
          return;
        }
        
        currentPhotoIndex = index;
        const img = document.getElementById('photoViewerImage');
        const loading = document.getElementById('photoLoading');
        
        console.log('写真を表示:', (index + 1) + '/' + currentPhotos.length);
        console.log('URL:', currentPhotos[index]);
        
        loading.style.display = 'flex';
        loading.innerHTML = '<div class="spinner-border text-light" role="status"></div>';
        img.style.display = 'none';
        
        // 画像読み込み完了時
        img.onload = function() {
          console.log('画像読み込み完了');
          loading.style.display = 'none';
          img.style.display = 'block';
        };
        
        // 画像読み込みエラー時
        img.onerror = function() {
          console.error('画像読み込みエラー:', currentPhotos[index]);
          loading.innerHTML = '<div class="text-light"><i class="bi bi-exclamation-triangle"></i><br>画像の読み込みに失敗しました</div>';
          
          // 次の画像があれば自動的にスキップ
          if (currentPhotos.length > 1 && index < currentPhotos.length - 1) {
            setTimeout(() => {
              showPhoto(index + 1);
            }, 1000);
          }
        };
        
        img.src = currentPhotos[index];
        
        // ナビゲーションボタンの表示/非表示
        document.getElementById('prevPhotoBtn').style.display = (currentPhotos.length > 1) ? 'block' : 'none';
        document.getElementById('nextPhotoBtn').style.display = (currentPhotos.length > 1) ? 'block' : 'none';
        
        // カウンター表示
        const counter = document.getElementById('photoCounter');
        counter.innerText = `${index + 1} / ${currentPhotos.length}`;
        counter.style.display = 'block';
      }
      
      // 写真をナビゲート
      function navigatePhoto(direction) {
        if (!currentPhotos || currentPhotos.length === 0) return;
        
        let newIndex = currentPhotoIndex + direction;
        
        // ループ処理
        if (newIndex < 0) {
          newIndex = currentPhotos.length - 1;
        } else if (newIndex >= currentPhotos.length) {
          newIndex = 0;
        }
        
        showPhoto(newIndex);
      }
      
      // キーボードナビゲーション
      document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('photoViewerModal');
        if (modal.classList.contains('show')) {
          if (e.key === 'ArrowLeft') {
            navigatePhoto(-1);
          } else if (e.key === 'ArrowRight') {
            navigatePhoto(1);
          } else if (e.key === 'Escape') {
            bootstrap.Modal.getInstance(modal).hide();
          }
        }
      });

      function openRegisterModal() {
        document.getElementById('modalTitle').innerText = "イベント登録";
        document.getElementById('form').reset();
        document.getElementById('rowNumber').value = "";
        // 画像位置リセット処理を削除
        document.getElementById('deleteBtn').style.display = 'none';
        new bootstrap.Modal(document.getElementById('dataModal')).show();
      }

      function openEditModal(rowNumber) {
        const item = currentDataList.find(i => i.rowNumber == rowNumber);
        if (!item) return;
        const d = item.data;

        document.getElementById('modalTitle').innerText = "イベント編集";
        document.getElementById('rowNumber').value = rowNumber;
        document.getElementById('date').value = d[0];
        document.getElementById('name').value = d[1];
        document.getElementById('location').value = d[2];
        document.getElementById('count').value = d[3];
        document.getElementById('albumUrl').value = d[4]; 
        // thumbUrlは削除（表示不要）
        document.getElementById('docUrl').value = d[6];   
        document.getElementById('members').value = d[7];

        document.getElementById('deleteBtn').style.display = 'block';
        new bootstrap.Modal(document.getElementById('dataModal')).show();
      }

      function saveData() {
        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerText;
        btn.disabled = true; 
        btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...`;

        const data = {
          rowNumber: document.getElementById('rowNumber').value,
          date: document.getElementById('date').value,
          name: document.getElementById('name').value,
          location: document.getElementById('location').value,
          count: document.getElementById('count').value,
          albumUrl: document.getElementById('albumUrl').value,
          thumbUrl: '', // 空文字を送信（GAS側で自動取得）
          docUrl: document.getElementById('docUrl').value,
          members: document.getElementById('members').value
        };

        google.script.run.withSuccessHandler(() => {
          bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
          loadData();
          btn.disabled = false; 
          btn.innerText = originalText;
        }).saveEvent(data);
      }

      function deleteCurrentData() {
        const row = document.getElementById('rowNumber').value;
        if(!row) return;
        if(confirm("削除しますか？")) {
           const btn = document.getElementById('deleteBtn');
           btn.disabled = true; 
           btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> 削除中...`;

           google.script.run.withSuccessHandler(() => {
             bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
             btn.disabled = false; btn.innerText = "削除";
             loadData();
           }).deleteEvent(row);
        }
      }
    </script>
  </body>
</html>